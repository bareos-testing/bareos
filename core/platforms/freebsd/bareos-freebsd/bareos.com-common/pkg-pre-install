#!/bin/sh
set -e

LOGFILE=/tmp/bareos-setup.log

echo "$PKG_NAME: upgrade=${PKG_UPGRADE}, pkg-preinstall, logs to ${LOGFILE}"

pkg query '%v' "$PKG_NAME" || echo "$PKG_NAME not installed"

if [ "${PKG_UPGRADE}" ]; then

    COMPONENT=""
    case "$PKG_NAME" in
    bareos.com-director)
        COMPONENT="bareos-dir"
        ;;
    bareos.com-filedaemon)
        COMPONENT="bareos-fd"
        ;;
    bareos.com-storage)
        COMPONENT="bareos-sd"
        ;;
    esac

    echo "COMPONENT=$COMPONENT"
    if [ "$COMPONENT" ]; then
        OLD_VERSION=$(pkg query '%v' "$PKG_NAME")
        if [ "${OLD_VERSION%%.*}" -lt "25" ]; then
            BAREOS_CONFIG_DIR="/usr/local/etc/bareos/"
            DEST_CONFIG_PATH="${BAREOS_CONFIG_DIR}/${COMPONENT}.d-migration.keep"
            SOURCE_CONFIG_PATH="${BAREOS_CONFIG_DIR}/${COMPONENT}.d/"

            echo "$PKG_NAME: migration from version $OLD_VERSION requires"
            echo "     special handling of the configuration files."
            echo "     Existing configuration will be backed up to"
            echo "     $DEST_CONFIG_PATH"
            echo "     and copied back during postinstall."
            
            if [ -d "${SOURCE_CONFIG_PATH}" ]; then
                if [ -e "${DEST_CONFIG_PATH}" ]; then
                    echo "$PKG_NAME: config migration directory ("${DEST_CONFIG_PATH}") already exists. giving up."
                    exit 1
                fi
                cp -av "${SOURCE_CONFIG_PATH}" "${DEST_CONFIG_PATH}"
            fi
        fi
    fi
fi
